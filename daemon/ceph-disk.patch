--- old/ceph-disk	2015-11-10 12:12:02.000000000 +0000
+++ new/ceph-disk	2016-01-25 14:58:55.700330570 +0000
@@ -147,6 +147,10 @@
     LOG_NAME = os.path.basename(sys.argv[0])
 LOG = logging.getLogger(LOG_NAME)
 
+# Allow user-preferred values for subprocess user and group
+CEPH_PREF_USER = None
+CEPH_PREF_GROUP = None
+
 
 ###### lock ########
 
@@ -841,12 +845,34 @@
     return osd_id
 
 def get_ceph_user():
-    try:
-        pwd.getpwnam('ceph')
-        grp.getgrnam('ceph')
-        return 'ceph'
-    except KeyError:
-        return 'root'
+    if CEPH_PREF_USER != None:
+        try:
+            pwd.getpwnam(CEPH_PREF_USER)
+            return CEPH_PREF_USER
+        except KeyError:
+            print "No such user: " + CEPH_PREF_USER
+            sys.exit(2)
+    else:
+        try:
+            pwd.getpwnam('ceph')
+            return 'ceph'
+        except KeyError:
+            return 'root'
+
+def get_ceph_group():
+    if CEPH_PREF_GROUP != None:
+        try:
+            grp.getgrnam(CEPH_PREF_GROUP)
+            return CEPH_PREF_GROUP
+        except KeyError:
+            print "No such group: " + CEPH_PREF_GROUP
+            sys.exit(2)
+    else:
+        try:
+            grp.getgrnam('ceph')
+            return 'ceph'
+        except KeyError:
+            return 'root'
 
 def path_set_context(path):
     # restore selinux context to default policy values
@@ -1947,7 +1973,7 @@
             '--osd-uuid', fsid,
             '--keyring', os.path.join(path, 'keyring'),
             '--setuser', get_ceph_user(),
-            '--setgroup', get_ceph_user(),
+            '--setgroup', get_ceph_group(),
             ],
         )
     # TODO ceph-osd --mkfs removes the monmap file?
@@ -3233,6 +3259,18 @@
         default='/etc/ceph',
         help='directory in which ceph configuration files are found (default /etc/ceph)',
         )
+    parser.add_argument(
+	'--setuser',
+        metavar='USER',
+	default=None,
+	help='use the given user for subprocesses, rather than ceph or root'
+	)
+    parser.add_argument(
+	'--setgroup',
+        metavar='GROUP',
+	default=None,
+	help='use the given group for subprocesses, rather than ceph or root'
+	)
     parser.set_defaults(
         # we want to hold on to this, for later
         prog=parser.prog,
@@ -3525,6 +3563,8 @@
 
     setup_statedir(args.statedir)
     setup_sysconfdir(args.sysconfdir)
+    CEPH_PREF_USER=args.setuser
+    CEPH_PREF_GROUP=args.setgroup
 
     if args.verbose:
         args.func(args)
